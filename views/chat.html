<!-- <!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App</title>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <style>
      /* General Styles */
      body {
        font-family: "Arial", sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: linear-gradient(135deg, #2575fc, #6a11cb);
        color: #333;
      }

      /* Container Styles */
      #chat-container {
        width: 400px;
        background: white;
        padding: 20px;
        box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.2);
        border-radius: 15px;
        text-align: center;
        animation: fadeIn 0.5s ease-in-out;
      }

      /* Form and Chat Box Styles */
      #user-form,
      #chat-box {
        display: none;
      }

      #user-form h2,
      #chat-box h2 {
        margin-bottom: 20px;
        color: #2575fc;
        font-size: 24px;
      }

      /* Messages Container */
      #messages {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        background: #fafafa;
        border-radius: 10px;
        scroll-behavior: smooth;
      }

      /* Message Styles */
      .message {
        padding: 10px;
        margin: 10px 0;
        border-radius: 10px;
        max-width: 70%;
        word-wrap: break-word;
        animation: slideIn 0.3s ease-in-out;
        position: relative;
      }

      .sent {
        background: #2575fc;
        color: white;
        margin-left: auto;
      }

      .received {
        background: #eee;
        margin-right: auto;
      }

      .message .timestamp {
        display: block;
        font-size: 10px;
        color: rgba(0, 0, 0, 0.5);
        margin-top: 5px;
        text-align: right;
      }

      .received .timestamp {
        color: rgba(0, 0, 0, 0.5);
        text-align: left;
      }

      /* Input and Button Styles */
      input,
      select,
      button {
        width: 80%;
        padding: 12px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      input:focus,
      select:focus,
      button:focus {
        outline: none;
        border-color: #2575fc;
        box-shadow: 0 0 5px rgba(37, 117, 252, 0.5);
      }

      button {
        background: #2575fc;
        color: white;
        cursor: pointer;
        font-weight: bold;
      }

      button:hover {
        background: #1a5bbf;
        transform: translateY(-2px);
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* Scrollbar Styles */
      #messages::-webkit-scrollbar {
        width: 8px;
      }

      #messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      #messages::-webkit-scrollbar-thumb {
        background: #2575fc;
        border-radius: 10px;
      }

      #messages::-webkit-scrollbar-thumb:hover {
        background: #1a5bbf;
      }

      /* Responsive Design */
      @media (max-width: 480px) {
        #chat-container {
          width: 90%;
          padding: 15px;
        }

        #messages {
          height: 250px;
        }

        input,
        select,
        button {
          width: 90%;
        }
      }
    </style>
  </head>
  <body>
    <div id="user-form">
      <h2>Login</h2>
      <input type="text" id="username" placeholder="Enter your username" />
      <button onclick="registerUser()">Join Chat</button>
    </div>

    <div id="chat-box">
      <h2>Chat with <span id="chat-partner"></span></h2>
      <select id="users-list" onchange="selectUser()">
        <option value="">Select a user</option>
      </select>
      <div id="messages"></div>
      <input type="text" id="message-input" placeholder="Type a message..." />
      <button onclick="sendMessage()">Send</button>
    </div>

    <script>
      // const socket = io("http://192.168.1.5:4000");
      const socket = io("http://192.168.88.167:4000");
      let username = sessionStorage.getItem("username") || "";
      let chatPartner = "";

      function registerUser() {
        const usernameInput = document.getElementById("username").value.trim();
        if (usernameInput) {
          sessionStorage.setItem("username", usernameInput);
          username = usernameInput;
          socket.emit("register", username);
          document.getElementById("user-form").style.display = "none";
          document.getElementById("chat-box").style.display = "block";
        } else {
          alert("Please enter a username!");
        }
      }

      socket.on("updateUsers", (users) => {
        const usersList = document.getElementById("users-list");
        usersList.innerHTML = '<option value="">Select a user</option>';

        Object.keys(users).forEach((user) => {
          if (user !== username) {
            usersList.innerHTML += `<option value="${user}">${user}</option>`;
          }
        });
      });

      function selectUser() {
        chatPartner = document.getElementById("users-list").value;
        document.getElementById("chat-partner").textContent = chatPartner;
        document.getElementById("messages").innerHTML = "";
        if (chatPartner) {
          socket.emit("loadMessages", {
            sender: username,
            receiver: chatPartner,
          });
        }
      }

      socket.on("previousMessages", (messages) => {
        messages.forEach((msg) =>
          displayMessage(msg, msg.sender === username ? "sent" : "received")
        );
      });

      socket.on("receiveMessage", (data) => {
        if (data.sender === chatPartner || data.receiver === chatPartner) {
          displayMessage(data, data.sender === username ? "sent" : "received");
        }
      });

      function sendMessage() {
        const message = document.getElementById("message-input").value.trim();
        if (message && chatPartner) {
          const data = {
            sender: username,
            receiver: chatPartner,
            message,
            timestamp: new Date().toLocaleTimeString(),
          };
          socket.emit("sendMessage", data);
          document.getElementById("message-input").value = "";
        } else {
          alert("Please select a user first.");
        }
      }

      function displayMessage(data, type) {
        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${type}`;
        msgDiv.innerHTML = `
          <div>${data.sender}: ${data.message}</div>
          <div class="timestamp">${data.timestamp}</div>
        `;
        document.getElementById("messages").appendChild(msgDiv);
        document.getElementById("messages").scrollTop =
          document.getElementById("messages").scrollHeight;
      }

      if (username) {
        document.getElementById("user-form").style.display = "none";
        document.getElementById("chat-box").style.display = "block";
        socket.emit("register", username);
      }
    </script>
  </body>
</html> -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ويب شات</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Arial", sans-serif;
      }

      body {
        background: #f0f2f5;
        color: #333;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      .chat-app {
        display: flex;
        width: 900px;
        height: 600px;
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        overflow: hidden;
      }

      .sidebar {
        width: 300px;
        background: #2c3e50;
        color: white;
        display: flex;
        flex-direction: column;
        padding: 10px;
      }

      .header {
        padding: 15px;
        background: #34495e;
        text-align: center;
        border-bottom: 1px solid #3e5c76;
      }

      .header h2 {
        font-size: 20px;
        color: #ecf0f1;
      }

      .search-box {
        padding: 10px;
        position: relative;
      }

      #search-input {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 20px;
        background: #34495e;
        color: white;
        outline: none;
        transition: background 0.3s;
      }

      #search-input::placeholder {
        color: #bdc3c7;
      }

      #search-input:focus {
        background: #3e5c76;
      }

      .search-results {
        position: absolute;
        top: 60px;
        left: 10px;
        right: 10px;
        background: #34495e;
        border-radius: 5px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .search-result {
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #3e5c76;
        transition: background 0.2s;
      }

      .search-result:hover {
        background: #3e5c76;
      }

      .search-result button {
        padding: 5px 10px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 15px;
        cursor: pointer;
      }

      .search-result button:hover {
        background: #2980b9;
      }

      .pending-requests,
      .user-list {
        list-style: none;
        flex-grow: 1;
        overflow-y: auto;
      }

      .pending-requests h3,
      .user-list h3 {
        padding: 10px;
        font-size: 14px;
        color: #bdc3c7;
        text-transform: uppercase;
      }

      .request,
      .user {
        display: flex;
        align-items: center;
        padding: 10px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .request:hover,
      .user:hover {
        background: #34495e;
      }

      .request img,
      .user img {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        margin-left: 10px;
      }

      .user-info {
        flex-grow: 1;
      }

      .username {
        font-size: 16px;
        color: #ecf0f1;
      }

      .status {
        font-size: 12px;
      }

      .status.online {
        color: #2ecc71;
      }

      .status.offline {
        color: #95a5a6;
      }

      .request button {
        padding: 5px 10px;
        background: #2ecc71;
        color: white;
        border: none;
        border-radius: 15px;
        cursor: pointer;
      }

      .request button:hover {
        background: #27ae60;
      }

      .chat-window {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }

      .chat-header {
        padding: 15px;
        background: #ecf0f1;
        border-bottom: 1px solid #ddd;
        display: flex;
        align-items: center;
      }

      .chat-header img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-left: 10px;
      }

      .chat-messages {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        background: #fff;
      }

      .message {
        display: flex;
        align-items: flex-start;
        margin: 10px 0;
        max-width: 70%;
      }

      .message.sent {
        margin-right: auto;
        flex-direction: row-reverse;
      }

      .message.received {
        margin-left: auto;
      }

      .message img {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        margin: 0 10px;
      }

      .message-content {
        padding: 10px;
        border-radius: 10px;
        background: #e9ecef;
      }

      .message.sent .message-content {
        background: #3498db;
        color: white;
      }

      .text {
        display: block;
      }

      .time {
        font-size: 10px;
        color: #7f8c8d;
        margin-top: 5px;
      }

      .message.sent .time {
        color: #bdc3c7;
      }

      .chat-input {
        padding: 15px;
        display: flex;
        background: #ecf0f1;
      }

      .chat-input input {
        flex-grow: 1;
        padding: 10px;
        border: none;
        border-radius: 20px;
        margin-left: 10px;
        outline: none;
      }

      .chat-input button {
        padding: 10px 20px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
      }

      .chat-input button:hover {
        background: #2980b9;
      }

      .action-menu {
        position: absolute;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .action-menu button {
        display: block;
        width: 100%;
        padding: 8px 15px;
        border: none;
        background: none;
        text-align: right;
        cursor: pointer;
      }

      .action-menu button:hover {
        background: #f0f0f0;
      }
    </style>
  </head>
  <body>
    <div class="chat-app">
      <div class="sidebar">
        <div class="header">
          <h2>الدردشة</h2>
        </div>
        <div class="search-box">
          <input type="text" id="search-input" placeholder="بحث عن مستخدم..." />
          <div id="search-results" class="search-results"></div>
        </div>
        <h3>طلبات الاتصال</h3>
        <ul class="pending-requests"></ul>
        <h3>الأصدقاء</h3>
        <ul class="user-list"></ul>
      </div>
      <div class="chat-window">
        <div class="chat-header">
          <div class="user-info">
            <img src="https://via.placeholder.com/40" alt="صورة المستخدم" />
            <span class="username"></span>
            <span class="status"></span>
          </div>
        </div>
        <div class="chat-messages"></div>
        <div class="chat-input">
          <input type="text" placeholder="اكتب رسالتك هنا..." />
          <button onclick="sendMessage()">إرسال</button>
        </div>
      </div>
    </div>
    <div id="action-menu" class="action-menu">
      <button onclick="deleteSelectedMessage()">حذف</button>
      <button onclick="replyToMessage()">رد</button>
      <button onclick="copyMessage()">نسخ</button>
    </div>

    <!-- Replace the <script> section in your chat.html with this -->
    <script>
      const LOCAL_IP = "192.168.1.8";
      const socket = io(`http://${LOCAL_IP}:4000`);
      const chatMessages = document.querySelector(".chat-messages");
      const messageInput = document.querySelector(".chat-input input");
      const sendButton = document.querySelector(".chat-input button");
      const userList = document.querySelector(".user-list");
      const pendingRequests = document.querySelector(".pending-requests");
      const searchInput = document.querySelector("#search-input");
      const searchResults = document.querySelector("#search-results");

      let email = sessionStorage.getItem("email") || "";
      let chatPartner = "";
      let selectedMessageId = null;

      socket.on("connect", () => console.log("✅ Connected to server"));
      socket.on("connect_error", (err) =>
        console.error("❌ Connection error:", err.message)
      );
      socket.on("error", (msg) => alert(msg));

      if (!email) {
        email = prompt("أدخل بريدك الإلكتروني:");
        if (email) {
          sessionStorage.setItem("email", email);
          socket.emit("register", email);
        } else {
          alert("يرجى إدخال بريد إلكتروني!");
          window.lofcation.reload();
        }
      } else {
        socket.emit("register", email);
      }

      socket.on("updateUsers", ({ connections, pendingRequests: requests }) => {
        userList.innerHTML = "";
        connections.forEach(({ email: userEmail, online }) => {
          const li = document.createElement("li");
          li.classList.add("user");
          li.innerHTML = `
        <img src="https://via.placeholder.com/40" alt="صورة المستخدم" />
        <div class="user-info">
          <span class="username">${userEmail}</span>
          <span class="status ${online ? "online" : "offline"}">${
            online ? "متصل" : "غير متصل"
          }</span>
        </div>
      `;
          li.addEventListener("click", () => selectChatPartner(userEmail));
          userList.appendChild(li);
        });

        pendingRequests.innerHTML = "";
        requests.forEach((userEmail) => {
          const li = document.createElement("li");
          li.classList.add("request");
          li.innerHTML = `
        <img src="https://via.placeholder.com/40" alt="صورة المستخدم" />
        <div class="user-info">
          <span class="username">${userEmail}</span>
        </div>
        <button onclick="acceptConnection('${userEmail}')">قبول</button>
      `;
          pendingRequests.appendChild(li);
        });
      });

      socket.on("connectionRequest", ({ from }) => {
        alert(`${from} أرسل طلب اتصال!`);
        socket.emit("register", email);
      });

      function selectChatPartner(selectedEmail) {
        chatPartner = selectedEmail;
        const statusElement = document.querySelector(".chat-header .status");
        const userStatus = Array.from(userList.querySelectorAll(".user")).find(
          (li) => li.querySelector(".username").textContent === selectedEmail
        );
        const isOnline = userStatus
          ? userStatus.querySelector(".status").classList.contains("online")
          : false;
        document.querySelector(".chat-header .username").textContent =
          chatPartner;
        statusElement.textContent = isOnline ? "متصل" : "غير متصل";
        statusElement.className = `status ${isOnline ? "online" : "offline"}`;
        chatMessages.innerHTML = "";
        socket.emit("loadMessages", { sender: email, receiver: chatPartner });
      }

      socket.on("previousMessages", (messages) => {
        messages.forEach((msg) =>
          displayMessage(msg, msg.sender === email ? "sent" : "received")
        );
      });

      socket.on("receiveMessage", (data) => {
        if (data.sender === chatPartner || data.receiver === chatPartner) {
          displayMessage(data, data.sender === email ? "sent" : "received");
        }
      });

      socket.on("messageDeleted", ({ messageId }) => {
        const msgElement = document.querySelector(`[data-id="${messageId}"]`);
        if (msgElement) msgElement.remove();
      });

      function displayMessage(data, type) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", type);
        messageDiv.setAttribute("data-id", data._id);
        messageDiv.innerHTML = `
      ${
        type === "received"
          ? '<img src="https://via.placeholder.com/30" alt="صورة المستخدم" />'
          : ""
      }
      <div class="message-content">
        <span class="text">${data.message}</span>
        <span class="time">${new Date(data.timestamp).toLocaleTimeString(
          "ar"
        )}</span>
      </div>
    `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function sendMessage() {
        const message = messageInput.value.trim();
        if (!chatPartner) {
          alert("يرجى اختيار مستخدم للدردشة معه!");
          return;
        }
        if (!message) {
          alert("يرجى كتابة رسالة!");
          return;
        }
        const data = { sender: email, receiver: chatPartner, message };
        socket.emit("sendMessage", data);
        messageInput.value = "";
      }

      function acceptConnection(from) {
        socket.emit("acceptConnection", { from, to: email });
      }

      let searchTimeout;
      searchInput.addEventListener("input", (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        searchTimeout = setTimeout(() => {
          if (query) {
            socket.emit("searchUsers", { query, email });
          } else {
            searchResults.innerHTML = "";
          }
        }, 300);
      });

      socket.on("searchResults", (results) => {
        searchResults.innerHTML = "";
        results.forEach(({ email: userEmail, connected, pending }) => {
          const div = document.createElement("div");
          div.classList.add("search-result");
          div.innerHTML = `
        <span>${userEmail}</span>
        ${
          connected
            ? "<span>متصل</span>"
            : pending
            ? "<span>معلق</span>"
            : `<button onclick="sendConnectionRequest('${userEmail}')">طلب اتصال</button>`
        }
      `;
          searchResults.appendChild(div);
        });
      });

      function sendConnectionRequest(to) {
        socket.emit("sendConnectionRequest", { from: email, to });
        searchResults.innerHTML = "";
      }

      function deleteSelectedMessage() {
        if (selectedMessageId) {
          socket.emit("deleteMessage", { messageId: selectedMessageId });
          selectedMessageId = null;
        } else {
          alert("يرجى تحديد رسالة لحذفها!");
        }
      }

      sendButton.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      const actionMenu = document.getElementById("action-menu");
      chatMessages.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        const messageDiv = e.target.closest(".message");
        if (messageDiv) {
          selectedMessageId = messageDiv.getAttribute("data-id");
          actionMenu.style.display = "block";
          actionMenu.style.top = `${e.pageY}px`;
          actionMenu.style.left = `${e.pageX}px`;
        }
      });

      document.addEventListener("click", () => {
        actionMenu.style.display = "none";
      });

      function replyToMessage() {
        alert("الرد على الرسالة - لم يتم تنفيذ هذه الوظيفة بعد");
      }

      function copyMessage() {
        alert("نسخ الرسالة - لم يتم تنفيذ هذه الوظيفة بعد");
      }
    </script>
  </body>
</html>
